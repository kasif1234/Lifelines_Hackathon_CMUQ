#include <map>
#include <string>
#include <SPI.h>
#include <LoRa.h>
#include <WiFi.h>
#include <WebServer.h>


#define SS 18
#define RST 14
#define DIO0 26
#define SCK 5
#define MISO 19
#define MOSI 27
#define LORA_BAND 868E6

#define TRIG 13   // Water level sensor
#define ECHO 12
#define TRIG2 17  // Soap level sensor
#define ECHO2 15
#define SOUND_SPEED 0.0346 // In cm/microsecond 
#define IRSENSOR 22   // Population sensor
#define IR2SENSOR 4  // Restroom sensor

const char charset[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
std::map<std::string, int> resources;
long t;  // Water level
float distance;
float average;
long t2;  // Soap level
float distance2;
float average2;
bool sensed = true;  // Water level
bool sensed2 = true; // Soap level
int counter = 0;  // Population
int counter2 = 0;  // Restroom access
unsigned long sonicInterval = 5000;
unsigned long lastTime = 0;
unsigned long lastPacketSent = 0;
unsigned long IRHighStart = 0;  // Population
unsigned long IRDebounceTime = 200;
int currentIRState;
unsigned long IR2HighStart = 0;  // Restroom access
unsigned long IR2DebounceTime = 200;
int currentIR2State;
unsigned long now;


const char* SSID = "FacilityA";
const char* PASS = "12345678";

WebServer server(80);

void sendCorsHeaders() {
  server.sendHeader("Access-Control-Allow-Origin", "*");
  server.sendHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  server.sendHeader("Access-Control-Allow-Headers", "*");
  // Chrome Private Network Access (PNA) fix:
  server.sendHeader("Access-Control-Allow-Private-Network", "true");
}
void handleSensorsOptions() {
  sendCorsHeaders();
  server.send(204); // No Content for preflight
}
void setup() 
  {
    Serial.begin(115200); 
    pinMode(TRIG, OUTPUT); 
    pinMode(ECHO, INPUT);
    pinMode(TRIG2, OUTPUT);
    pinMode(ECHO2, INPUT);
    pinMode(IRSENSOR, INPUT);
    pinMode(IR2SENSOR, INPUT);
    digitalWrite(TRIG, LOW); 
    SPI.begin(SCK, MISO, MOSI, SS);
    LoRa.setPins(SS, RST, DIO0);
    if (!LoRa.begin(LORA_BAND)) {
        Serial.println("LoRa failed to start!");
        while (1);
    }
    WiFi.mode(WIFI_AP);
    WiFi.softAP(SSID, PASS);
    server.on("/sensorsdata", HTTP_GET, handleToApp);   
    server.on("/sensorsdata", HTTP_OPTIONS, handleSensorsOptions);
    server.onNotFound([]() {
    if (server.method() == HTTP_OPTIONS) {
      sendCorsHeaders();
      server.send(204);
      return;
    }
    sendCorsHeaders();
    server.send(404, "text/plain", "Not found");
  });//From esp to app
    server.begin();
    

    }
void loop() {   
    server.handleClient();
    now = millis();
    average = 0;
    average2 = 0;
    currentIRState = digitalRead(IRSENSOR);
    currentIR2State = digitalRead(IR2SENSOR);
    if (currentIRState == LOW && sensed){
        counter++;
        sensed = false;
        IRHighStart = 0;
        Serial.print("Population counter: ");
        Serial.println(counter);

    }
    if (currentIR2State == LOW && sensed2){
        counter2++;
        sensed2 = false;
        IR2HighStart = 0;
        Serial.print("Restroom access counter: ");
        Serial.println(counter2);

    }
   
    if (!sensed) {
      if (currentIRState == HIGH) {
        if (IRHighStart == 0) IRHighStart = now;
        if (now - IRHighStart >= IRDebounceTime) {
          sensed = true;
          IRHighStart = 0;
        }
      } else {
        IRHighStart = 0; 
      }
  }
      if (!sensed2) {
      if (currentIR2State == HIGH) {
        if (IR2HighStart == 0) IR2HighStart = now;
        if (now - IR2HighStart >= IR2DebounceTime) {
          sensed2 = true;
          IR2HighStart = 0;
        }
      } else {
        IR2HighStart = 0; 
      }
  }
    
    if (now - lastTime >= sonicInterval){
      for (int i=0; i<5; i++){
        digitalWrite(TRIG, LOW);
        
        delayMicroseconds(10);
        digitalWrite(TRIG, HIGH);
       
        delayMicroseconds(10);
        digitalWrite(TRIG, LOW);
        
        t = pulseIn(ECHO , HIGH);
        
        distance = (t/2)*SOUND_SPEED ;
        average += distance;
        
        delay(10);
      }
            for (int i=0; i<5; i++){
        digitalWrite(TRIG2, LOW);
        
        delayMicroseconds(10);
        digitalWrite(TRIG2, HIGH);
       
        delayMicroseconds(10);
        digitalWrite(TRIG2, LOW);
        
        t2 = pulseIn(ECHO2 , HIGH);
        
        distance2 = (t2/2)*SOUND_SPEED ;
        average2 += distance2;
        
        delay(10);
      }

      lastTime = now;
      average = average / 5;
      average2 = average2 / 5;
      resources["Water"] = round(average);
      resources["Population"] = counter;
      resources["Soap"] = round(average2);
      resources["RR1"] = counter2;
      sendToESP32();
    }
   
}
String generateID() {
  String id = "";

  for (int i = 0; i < 8; i++) {
    int index = random(0, sizeof(charset) - 1);
    id += charset[index];
  }

  return id;
}

void sendToESP32() {
    String packet;
      packet = String("FacilityA")+"|"+"Water"+"|"+resources["Water"]+"|"+"Population"+"|"+resources["Population"]+"|"+String("Soap")+"|"+resources["Soap"]+"|"+String("RR1")+"|"+resources["RR1"];
      Serial.println(packet);
      Serial.println(WiFi.softAPIP());
      LoRa.beginPacket();
      LoRa.print(packet);
      LoRa.endPacket();
      delay(10);
    
}
void handleToApp(){
  String msg = String("FacilityA")+"|"+"Water"+"|"+resources["Water"]+"|"+"Population"+"|"+resources["Population"]+"|"+String("Soap")+"|"+resources["Soap"]+"|"+String("RR1")+"|"+resources["RR1"];
  server.send(200, "text/plain", msg);
}

